{% extends "base.html" %}
{% block title %}Заказы{% endblock %}
{% block content %}
<div class="card">
  <div class="card-head">
    <h2>Заказы</h2>
    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="reload" class="btn">Обновить</button>
      <button id="toggleCreate" class="btn primary">Создать заказ</button>
    </div>
  </div>

  <!-- ФИЛЬТРЫ -->
  <div class="panel" style="margin-bottom:12px">
    <div style="display:grid;grid-template-columns:1fr 280px 160px;gap:10px;align-items:end">
      <div>
        <label>Поиск по email</label>
        <input type="text" id="fEmail" placeholder="user@example.com">
      </div>
      <div>
        <label>Статусы (через запятую)</label>
        <input type="text" id="fStatuses" placeholder="paid, shipped, canceled">
      </div>
      <div>
        <label>Сортировка</label>
        <select id="fSort">
          <option value="none">Без сортировки</option>
          <option value="total_asc">Сумма ↑</option>
          <option value="total_desc">Сумма ↓</option>
        </select>
      </div>
    </div>
  </div>

  <!-- СОЗДАНИЕ -->
  <div id="createBox" class="panel" style="display:none; margin-bottom:12px">
    <h3 style="margin:0 0 10px">Новый заказ</h3>
    <div class="muted" style="margin-bottom:8px">
      Будет создан от имени текущего пользователя (суперюзера).
    </div>
    <form id="createForm">
      <div style="display:grid;grid-template-columns:1fr 200px;gap:10px;align-items:end">
        <div>
          <label>Позиции (пары <code>product_id:qty</code>, через запятую)</label>
          <input type="text" name="pairs" placeholder="101:2, 305:1, 402:5" />
        </div>
        <button class="btn primary" type="submit">Создать</button>
      </div>
      <div id="createError" class="error" style="display:none;margin-top:10px"></div>
    </form>
  </div>

  <!-- СПИСОК -->
  <div id="grid" class="panel" style="overflow:auto">Загрузка…</div>

  <!-- ДЕТАЛИ -->
  <div id="detail" class="panel" style="display:none; margin-top:12px"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const fmt = (v)=> v ?? "-";
let ORDERS = [];      // оригинальные данные
let FILTERED = [];    // отфильтрованные

function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

function parseStatuses(s){
  return s.split(",").map(x=>x.trim().toLowerCase()).filter(Boolean);
}

function totalOf(o){
  return (o.total_amount ?? o.total_price ?? 0) || 0;
}

function applyFilters(){
  const email = document.getElementById("fEmail").value.trim().toLowerCase();
  const statuses = parseStatuses(document.getElementById("fStatuses").value);
  const sort = document.getElementById("fSort").value;

  let rows = ORDERS.slice();

  if (email){
    rows = rows.filter(o => (o.user?.email ?? String(o.user_id ?? "")).toLowerCase().includes(email));
  }
  if (statuses.length){
    rows = rows.filter(o => statuses.includes(String(o.status ?? "").toLowerCase()));
  }

  if (sort === "total_asc") rows.sort((a,b)=> totalOf(a) - totalOf(b));
  if (sort === "total_desc") rows.sort((a,b)=> totalOf(b) - totalOf(a));

  FILTERED = rows;
  renderTable(rows);
}

function renderTable(data){
  const grid = document.getElementById("grid");
  if(!data.length){ grid.innerHTML = "<div class='muted'>Нет заказов</div>"; return; }
  const rows = data.map(o => `
    <tr data-id="${o.id}">
      <td>${o.id}</td>
      <td>${fmt(o.user?.email ?? o.user_id)}</td>
      <td>${fmt(o.status)}</td>
      <td>${fmt(totalOf(o))}</td>
      <td style="white-space:nowrap;display:flex;gap:6px">
        <button class="btn sm" data-act="open" data-id="${o.id}">Открыть</button>
        <button class="btn sm danger" data-act="del" data-id="${o.id}">Удалить</button>
      </td>
    </tr>
  `).join("");
  grid.innerHTML = `
    <table class="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Пользователь</th>
          <th>Статус</th>
          <th>Сумма</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

async function ensureSU() {
  const me = await authFetch("/users/me");
  if (!me.ok) { clearToken(); location.replace("/admin/login"); return null; }
  const u = await me.json();
  if (!u.is_superuser) { clearToken(); location.replace("/admin/login"); return null; }
  return u;
}

async function loadOrders() {
  const ok = await ensureSU(); if(!ok) return;
  const r = await authFetch("/orders/?limit=200&offset=0");
  const grid = document.getElementById("grid");
  if (!r.ok) { grid.innerHTML = `<div class="error">Ошибка: ${await r.text()}</div>`; return; }
  ORDERS = await r.json();
  applyFilters();
}

async function openOrder(orderId) {
  const ok = await ensureSU(); if(!ok) return;
  const r = await authFetch(`/orders/${orderId}`);
  const box = document.getElementById("detail");
  if (!r.ok) { box.style.display="block"; box.innerHTML = `<div class="error">Ошибка: ${await r.text()}</div>`; return; }
  const o = await r.json();

  const itemsRows = (o.items ?? []).map(it => `
    <tr>
      <td>${it.id}</td>
      <td>${fmt(it.product_id)}</td>
      <td>
        <input type="number" min="1" value="${it.quantity ?? 1}" data-item-id="${it.id}" class="qty-input" style="width:80px"/>
        <button class="btn sm" data-act="update-item" data-order-id="${o.id}" data-item-id="${it.id}">OK</button>
      </td>
      <td>${fmt(it.price)}</td>
      <td><button class="btn sm danger" data-act="remove-item" data-order-id="${o.id}" data-item-id="${it.id}">Удалить</button></td>
    </tr>
  `).join("");

  box.style.display = "block";
  box.innerHTML = `
    <h3 style="margin:0 0 8px">Заказ #${o.id}</h3>
    <div class="kv"><span>Пользователь</span><b>${fmt(o.user?.email ?? o.user_id)}</b></div>
    <div class="kv"><span>Статус</span><b>${fmt(o.status)}</b></div>
    <div class="kv"><span>Сумма</span><b>${fmt(totalOf(o))}</b></div>

    <div style="margin:12px 0; display:grid; grid-template-columns:1fr 120px; gap:8px; align-items:end">
      <div>
        <label>Новый статус</label>
        <input type="text" id="statusInput" placeholder="например: paid / shipped" value="${fmt(o.status) !== '-' ? o.status : ''}">
      </div>
      <button class="btn" data-act="update-status" data-id="${o.id}">Сохранить статус</button>
    </div>

    <h4 style="margin:14px 0 6px">Позиции</h4>
    <table class="tbl">
      <thead><tr><th>ID</th><th>Product</th><th>Кол-во</th><th>Цена</th><th></th></tr></thead>
      <tbody>${itemsRows || '<tr><td colspan="5" class="muted">Нет позиций</td></tr>'}</tbody>
    </table>

    <div style="margin-top:10px; display:grid; grid-template-columns:150px 120px 1fr; gap:8px; align-items:end">
      <div>
        <label>Product ID</label>
        <input type="number" id="addProductId" min="1" placeholder="123">
      </div>
      <div>
        <label>Qty</label>
        <input type="number" id="addQty" min="1" value="1">
      </div>
      <button class="btn primary" data-act="add-item" data-id="${o.id}">Добавить позицию</button>
    </div>

    <div style="margin-top:14px">
      <button class="btn danger" data-act="del" data-id="${o.id}">Удалить заказ</button>
    </div>
  `;
}

function parsePairsToPayload(pairsStr) {
  if (!pairsStr.trim()) return [];
  return pairsStr.split(",").map(x=>x.trim()).filter(Boolean).map(pair=>{
    const [pid, qty] = pair.split(":").map(v=>v.trim());
    return { product_id:Number(pid), quantity:Number(qty||1) };
  }).filter(it=> Number.isFinite(it.product_id) && Number.isFinite(it.quantity) && it.quantity>=1);
}

/* EVENTS */
document.getElementById("reload").addEventListener("click", loadOrders);

document.getElementById("grid").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;
  const id = btn.getAttribute("data-id");
  if(btn.dataset.act==="del"){
    if(!confirm(`Удалить заказ ${id}?`)) return;
    const r = await authFetch(`/orders/${id}`,{method:"DELETE"});
    if(r.status===204){ document.getElementById("detail").style.display="none"; loadOrders(); }
    else alert(await r.text());
  }
  if(btn.dataset.act==="open"){ openOrder(id); }
});

document.getElementById("detail").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-act]");
  if(!btn) return;
  const orderId = btn.getAttribute("data-id") || btn.getAttribute("data-order-id");

  if(btn.dataset.act==="update-status"){
    const payload = { status: document.getElementById("statusInput").value };
    const r = await authFetch(`/orders/${orderId}/meta`,{
      method:"PATCH", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!r.ok) return alert(await r.text());
    await openOrder(orderId); loadOrders();
  }

  if(btn.dataset.act==="add-item"){
    const pid = Number(document.getElementById("addProductId").value);
    const qty = Number(document.getElementById("addQty").value || 1);
    if(!Number.isFinite(pid)||pid<=0) return alert("Укажи корректный product_id");
    if(!Number.isFinite(qty)||qty<=0) return alert("Кол-во должно быть >=1");
    const r = await authFetch(`/orders/${orderId}/items`,{
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ product_id: pid, quantity: qty })
    });
    if(!r.ok) return alert(await r.text());
    await openOrder(orderId); loadOrders();
  }

  if(btn.dataset.act==="remove-item"){
    const itemId = btn.getAttribute("data-item-id");
    const r = await authFetch(`/orders/${orderId}/items/${itemId}`, { method:"DELETE" });
    if(!r.ok) return alert(await r.text());
    await openOrder(orderId); loadOrders();
  }

  if(btn.dataset.act==="update-item"){
    const itemId = btn.getAttribute("data-item-id");
    const qtyInput = document.querySelector(`.qty-input[data-item-id="${itemId}"]`);
    const qty = Number(qtyInput.value || 1);
    if(!Number.isFinite(qty)||qty<=0) return alert("Кол-во должно быть >=1");
    const r = await authFetch(`/orders/${orderId}/items/${itemId}`,{
      method:"PATCH", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ quantity: qty })
    });
    if(!r.ok) return alert(await r.text());
    await openOrder(orderId); loadOrders();
  }

  if(btn.dataset.act==="del"){
    if(!confirm(`Удалить заказ ${orderId}?`)) return;
    const r = await authFetch(`/orders/${orderId}`,{method:"DELETE"});
    if(r.status===204){ document.getElementById("detail").style.display="none"; loadOrders(); }
    else alert(await r.text());
  }
});

document.getElementById("toggleCreate").addEventListener("click", ()=>{
  const box = document.getElementById("createBox");
  box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
});

document.getElementById("createForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const err = document.getElementById("createError");
  err.style.display = "none";
  const items = parsePairsToPayload(e.target.elements["pairs"].value || "");
  if(!items.length){ err.textContent="Нужно указать хотя бы одну пару product_id:qty"; err.style.display="block"; return; }
  const r = await authFetch("/orders",{
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ items })
  });
  if(!r.ok){ err.textContent = await r.text(); err.style.display="block"; return; }
  e.target.reset(); document.getElementById("createBox").style.display="none"; loadOrders();
});

/* FILTER EVENTS */
const onFilterChanged = debounce(applyFilters, 200);
document.getElementById("fEmail").addEventListener("input", onFilterChanged);
document.getElementById("fStatuses").addEventListener("input", onFilterChanged);
document.getElementById("fSort").addEventListener("change", onFilterChanged);

loadOrders();
</script>
{% endblock %}
