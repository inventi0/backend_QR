{% extends "base.html" %}
{% block title %}Продукты{% endblock %}
{% block content %}
<div class="card">
  <div class="card-head">
    <h2>Продукты</h2>
    <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="reload" class="btn" type="button">Обновить</button>
      <button id="toggleCreate" class="btn primary" type="button">Создать продукт</button>
    </div>
  </div>

  <!-- ФИЛЬТРЫ -->
  <div class="panel" style="margin-bottom:12px">
    <form id="filters" style="display:grid;grid-template-columns:1fr 1fr 1fr 120px;gap:10px;align-items:end">
      <div>
        <label>Тип</label>
        <input type="text" id="fType" placeholder="Футболка">
      </div>
      <div>
        <label>Размер</label>
        <input type="text" id="fSize" placeholder="M">
      </div>
      <div>
        <label>Цвет</label>
        <input type="text" id="fColor" placeholder="Белый">
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="applyFilters" type="submit">Фильтр</button>
        <button class="btn ghost" id="resetFilters" type="button">Сброс</button>
      </div>
    </form>
  </div>

  <!-- ТАБЛИЦА -->
  <div id="grid" class="panel">Загрузка…</div>
</div>

<!-- CREATE PANEL -->
<div id="createPanel" class="panel" style="margin-top:12px; display:none">
  <h3>Создание продукта</h3>
  <form id="createForm" enctype="multipart/form-data" style="display:grid;gap:10px;grid-template-columns:repeat(6,1fr)">
    <div style="grid-column:span 2">
      <label>Тип*</label>
      <input name="p_type" required placeholder="Футболка">
    </div>
    <div>
      <label>Размер*</label>
      <select name="size" required>
        <option value="" disabled selected>Выберите</option>
        <option>XS</option><option>S</option><option>M</option>
        <option>L</option><option>XL</option><option>XXL</option>
      </select>
    </div>
    <div>
      <label>Цвет*</label>
      <input name="color" required placeholder="Белый">
    </div>
    <div>
      <label>Цена* (в мин. ед.)</label>
      <input name="price" type="number" min="0" required placeholder="1999">
    </div>
    <div style="grid-column:span 3">
      <label>Описание</label>
      <input name="description" placeholder="Короткое описание">
    </div>
    <div style="grid-column:span 3">
      <label>Изображение*</label>
      <input name="image" type="file" accept="image/*" required>
    </div>
    <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn ghost" type="button" id="cancelCreate">Отмена</button>
      <button class="btn primary" type="submit">Создать</button>
    </div>
  </form>
</div>

<!-- EDIT PANEL -->
<div id="editPanel" class="panel" style="margin-top:12px; display:none">
  <h3>Редактирование продукта <span id="editTitle" class="muted"></span></h3>
  <div style="display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap">
    <img id="editImage" src="" alt="Изображение продукта" style="width:160px;height:160px;object-fit:cover;border-radius:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15)">
    <form id="editForm" style="display:grid;gap:10px;grid-template-columns:repeat(6,1fr);min-width:360px">
      <input type="hidden" name="id">
      <div style="grid-column:span 2">
        <label>Тип</label>
        <input name="type" placeholder="Футболка">
      </div>
      <div>
        <label>Размер</label>
        <select name="size">
          <option value="">—</option>
          <option>XS</option><option>S</option><option>M</option>
          <option>L</option><option>XL</option><option>XXL</option>
        </select>
      </div>
      <div>
        <label>Цвет</label>
        <input name="color" placeholder="Белый">
      </div>
      <div>
        <label>Цена (в мин. ед.)</label>
        <input name="price" type="number" min="0" placeholder="1999">
      </div>
      <div style="grid-column:span 6">
        <label>Описание</label>
        <textarea name="description" rows="3" placeholder="Описание"></textarea>
      </div>

      <div style="grid-column:1 / -1; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn ghost" type="button" id="cancelEdit">Отмена</button>
        <button class="btn" id="saveMeta" type="submit">Сохранить</button>
      </div>
    </form>
  </div>

  <div style="margin-top:8px;display:grid;gap:10px">
    <h4>Замена изображения</h4>
    <form id="imageForm" enctype="multipart/form-data" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input type="file" name="image" accept="image/*" required>
      <button class="btn" type="submit">Заменить</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/** ========= helpers ========= **/
if (typeof authFetch !== "function") {
  window.authFetch = (url, opts={}) => fetch(url, {
    ...opts,
    headers: {
      "Authorization": `Bearer ${localStorage.getItem("token")||""}`,
      ...(opts.headers||{})
    }
  });
}
if (typeof clearToken !== "function") {
  window.clearToken = () => localStorage.removeItem("token");
}
const qs = (s)=>document.querySelector(s);

function toast(msg, type="info"){ console.log(`[${type}]`, msg); }
function fmtMoney(x){ return (x===null||x===undefined)?"-":new Intl.NumberFormat("ru-RU").format(x) }
function toQuery(params){
  const p = new URLSearchParams();
  Object.entries(params).forEach(([k,v])=>{ if(v!=="" && v!=null) p.set(k,v); });
  return p.toString();
}

/** ========= state ========= **/
let paging = { limit: 50, offset: 0 };
let filters = { type: "", size: "", color: "" };
let currentEditId = null;

/** ========= UI wiring ========= **/
const grid = document.getElementById("grid");
const reloadBtn = document.getElementById("reload");
const toggleCreateBtn = document.getElementById("toggleCreate");
const createPanel = document.getElementById("createPanel");
const createForm = document.getElementById("createForm");
const cancelCreate = document.getElementById("cancelCreate");

const editPanel = document.getElementById("editPanel");
const editForm = document.getElementById("editForm");
const imageForm = document.getElementById("imageForm");
const cancelEdit = document.getElementById("cancelEdit");
const editTitle = document.getElementById("editTitle");
const editImage = document.getElementById("editImage");

const fType = document.getElementById("fType");
const fSize = document.getElementById("fSize");
const fColor = document.getElementById("fColor");
const filtersForm = document.getElementById("filters");
const resetFiltersBtn = document.getElementById("resetFilters");

/** ========= auth gate ========= **/
async function guard(){
  const me = await authFetch("/users/me");
  if(!me.ok){ clearToken(); location.replace("/admin/login"); return false; }
  const u = await me.json();
  if(!u.is_superuser){ clearToken(); location.replace("/admin/login"); return false; }
  return true;
}

/** ========= data ops (routes) ========= **/
async function apiList(){
  const q = toQuery({
    limit: paging.limit,
    offset: paging.offset,
    type: filters.type || undefined,
    size: filters.size || undefined,
    color: filters.color || undefined
  });
  // важный слэш в конце
  return authFetch(`/products/?${q}`);
}
async function apiGet(id){ return authFetch(`/products/${id}`); }
async function apiCreate(formEl){ return authFetch(`/products`, { method:"POST", body:new FormData(formEl) }); }
async function apiPatchMeta(id, payload){
  return authFetch(`/products/${id}`, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });
}
async function apiPatchImage(id, formEl){ return authFetch(`/products/${id}/image`, { method:"PATCH", body:new FormData(formEl) }); }
async function apiDelete(id){ return authFetch(`/products/${id}`, { method:"DELETE" }); }

/** ========= rendering ========= **/
function renderRows(items){
  return items.map(p=>`
    <tr data-id="${p.id}">
      <td style="width:72px">
        ${p.img_url ? `<img src="${p.img_url}" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.15)">` : "—"}
      </td>
      <td>${p.id}</td>
      <td>${p.type ?? "-"}</td>
      <td>${p.size ?? "-"}</td>
      <td>${p.color ?? "-"}</td>
      <td style="text-align:right">${p.price != null ? fmtMoney(p.price) : "-"}</td>
      <td style="text-align:center">
        <div style="display:flex; gap:6px; justify-content:center">
          <button class="btn xs" data-act="view">Открыть</button>
          <button class="btn xs danger" data-act="del">Удалить</button>
        </div>
      </td>
    </tr>
  `).join("");
}

function renderTable(items){
  grid.innerHTML = `
    <table class="tbl">
      <thead>
        <tr>
          <th>Фото</th><th>ID</th><th>Тип</th><th>Размер</th><th>Цвет</th>
          <th style="text-align:right">Цена</th>
          <th style="text-align:center;width:220px">Действия</th>
        </tr>
      </thead>
      <tbody>${renderRows(items)}</tbody>
    </table>
  `;

  const tbody = grid.querySelector("tbody");
  // фикс: больше не одноразовый обработчик
  tbody.onclick = async (e)=>{
    const btn = e.target.closest("button[data-act]");
    if(!btn) return;
    const tr = btn.closest("tr");
    const id = Number(tr.dataset.id);
    const act = btn.dataset.act;

    if(act === "view"){
      await openEdit(id);
    }
    if(act === "del"){
      if(confirm(`Удалить продукт #${id}? Это действие необратимо.`)){
        const r = await apiDelete(id);
        if(r.ok){
          toast("Удалено", "success");
          if(currentEditId === id){ hideEdit(); }
          loadProducts();
        } else {
          toast(`Ошибка удаления: ${await r.text()}`, "error");
        }
      }
    }
  };
}

/** ========= flows ========= **/
async function loadProducts(){
  grid.innerHTML = "Загрузка…";
  const ok = await guard(); if(!ok) return;
  try{
    const r = await apiList();
    if(!r.ok){ grid.innerHTML = `<div class="error">Ошибка: ${await r.text()}</div>`; return; }
    const data = await r.json();
    if(!data.length){ grid.innerHTML = "<div class='muted'>Нет продуктов</div>"; return; }
    renderTable(data);
  }catch(err){
    grid.innerHTML = `<div class="error">Ошибка: ${err?.message||err}</div>`;
  }
}

function showCreate(){ createPanel.style.display = ""; toggleCreateBtn.disabled = true; }
function hideCreate(){ createPanel.style.display = "none"; toggleCreateBtn.disabled = false; createForm.reset(); }

function showEdit(){ editPanel.style.display = ""; }
function hideEdit(){ editPanel.style.display = "none"; currentEditId = null; editForm.reset(); imageForm.reset(); editTitle.textContent = ""; editImage.src = ""; }

async function openEdit(id){
  const r = await apiGet(id);
  if(!r.ok){ toast(`Ошибка загрузки продукта: ${await r.text()}`, "error"); return; }
  const p = await r.json();
  currentEditId = p.id;

  editTitle.textContent = `#${p.id} (${p.type||"-"} / ${p.size||"-"} / ${p.color||"-"})`;
  editImage.src = p.img_url || "";
  editImage.style.display = p.img_url ? "" : "none";

  // заполнение формы
  editForm.elements["id"].value = p.id;
  editForm.elements["type"].value = p.type || "";
  editForm.elements["size"].value = p.size || "";
  editForm.elements["color"].value = p.color || "";
  editForm.elements["price"].value = (p.price ?? "");
  editForm.elements["description"].value = p.description || "";

  showEdit();
}

/** ========= events ========= **/
document.getElementById("reload").addEventListener("click", loadProducts);

toggleCreateBtn.addEventListener("click", ()=>{
  const hidden = createPanel.style.display === "none" || !createPanel.style.display;
  hidden ? showCreate() : hideCreate();
});
cancelCreate.addEventListener("click", hideCreate);

createForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const r = await apiCreate(createForm);
  if(r.ok){
    toast("Создано", "success");
    hideCreate();
    await loadProducts();
  } else {
    toast(`Ошибка создания: ${await r.text()}`, "error");
  }
});

editForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!currentEditId) return;

  const payload = {};
  const t = editForm.elements["type"].value.trim(); if(t) payload.type = t;
  const s = editForm.elements["size"].value.trim(); if(s) payload.size = s;
  const c = editForm.elements["color"].value.trim(); if(c) payload.color = c;
  const d = editForm.elements["description"].value.trim(); if(d) payload.description = d;
  const pr = editForm.elements["price"].value;
  if(pr !== "") payload.price = Number(pr);

  const r = await apiPatchMeta(currentEditId, payload);
  if(r.ok){
    toast("Сохранено", "success");
    await loadProducts();
  } else {
    toast(`Ошибка сохранения: ${await r.text()}`, "error");
  }
});

imageForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(!currentEditId) return;
  const r = await apiPatchImage(currentEditId, imageForm);
  if(r.ok){
    const updated = await r.json(); // ответ роутера с актуальным img_url
    toast("Изображение обновлено", "success");
    imageForm.reset();
    // обновим превью без полного перезахода
    if(updated && updated.img_url){ editImage.src = updated.img_url; }
    await loadProducts();
  } else {
    toast(`Ошибка обновления изображения: ${await r.text()}`, "error");
  }
});

cancelEdit.addEventListener("click", hideEdit);

filtersForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  filters.type = fType.value.trim();
  filters.size = fSize.value.trim();
  filters.color = fColor.value.trim();
  paging.offset = 0;
  loadProducts();
});

resetFiltersBtn.addEventListener("click", ()=>{
  fType.value = fSize.value = fColor.value = "";
  filters = { type:"", size:"", color:"" };
  paging.offset = 0;
  loadProducts();
});

/** ========= boot ========= **/
loadProducts();
</script>
{% endblock %}
